---
title: "Store XML in a Database"
output:
  html_document:
    df_Print: paged
---

# Load Packages

```{r}
library(DBI)
library(RMySQL)
library(XML)
library(sqldf)
library(dplyr)    ## For removing duplicate values in dataframe
library(stringr)  ## For capitalization
library(ggplot2)
```

## Connect to AWS

```{r}
db_user <- "dbadmin"
db_name <- 'SandboxDB'
db_password <- "dos8JINT.kras8jaun"
db_host <- "cs5200-dbs.ctuc7sl6qeau.us-east-2.rds.amazonaws.com"
db_port <- 3306

dbcon <- dbConnect(MySQL(), dbname = db_name, host = db_host, 
                   port = db_port, user = db_user, password = db_password)
```

```{r}
killDbConnections <- function () {

  all_cons <- dbListConnections(MySQL())

  print(all_cons)

  for(con in all_cons)
    +  dbDisconnect(con)

  print(paste(length(all_cons), " connections killed."))

}
```

```{r}
#killDbConnections()
```


```{r}
# View tables in the database
dbListTables(dbcon)
```

```{sql connection=dbcon}
-- Turns off foreign key check
SET FOREIGN_KEY_CHECKS = 0;
```

# ERD

## TODO: Need to double check this ERD

![](Practicum2 - ERD.png "Practicum2 - ERD") <https://lucid.app/lucidchart/5a835436-ec1a-461a-94d4-bd4d46ece96f/edit?viewport_loc=-1125%2C-339%2C8042%2C3233%2CqB62~LJfXzY6&invitationId=inv_2685f3e2-beaf-4ddd-808d-a2ccd6c89094>

# Create Tables

## AUTHOR

```{sql connection=dbcon}
DROP TABLE IF EXISTS Author;
```

```{sql connection=dbcon}
CREATE TABLE Author (
  aut_id INT PRIMARY KEY AUTO_INCREMENT,
  author_last_name VARCHAR(255) NOT NULL,
  author_fore_name VARCHAR(255) NOT NULL,
  author_initials VARCHAR(255) NOT NULL
);
```

```{sql connection=dbcon}
SELECT * FROM Author;
```

## ARTICLE

```{sql connection=dbcon}
DROP TABLE IF EXISTS Article;
```

```{sql connection=dbcon}
CREATE TABLE Article (
  art_id INT PRIMARY KEY AUTO_INCREMENT,
  article_title VARCHAR(255) NOT NULL,
  journal_issue_id INT NOT NULL,
  pub_model ENUM('Print', 'Print-Electronic', 'Electronic', 'Electronic-Print', 'Electronic-eCollection') NOT NULL
);
```

```{sql connection=dbcon}
SELECT * FROM Article;
```

## ABSTRACT

```{sql connection=dbcon}
DROP TABLE IF EXISTS Abstract;
```

```{sql connection=dbcon}
CREATE TABLE Abstract (
  abstract_id INT PRIMARY KEY AUTO_INCREMENT,
  article_id INT NOT NULL,
  nlm_category ENUM("BACKGROUND", "UNASSIGNED", "METHODS", "RESULTS",
                    "CONCLUSIONS", "OBJECTIVE", "UNKNOWN") NOT NULL,
  abstract_label ENUM("BACKGROUND","PURPOSE AND QUESTIONS","PATIENTS AND METHODS",
                      "RESULTS","CONCLUSIONS","METHODS","BACKGROUND AND PURPOSE",
                      "BACKGROUND AND OBJECTIVES","PURPOSE","QUESTIONS/PURPOSES",
                      "OBJECTIVE","CONCLUSION","DESIGN","SETTINGS","PATIENTS",
                      "INTERVENTIONS","MAIN OUTCOME MEASURES","STUDY OBJECTIVE",
                      "SETTING","MEASUREMENTS","MAIN RESULTS","STUDY DESIGN",
                      "SUMMARY OF BACKGROUND DATA","INTRODUCTION","UNKNOWN") NOT NULL,
  abstract_text TEXT,
  
  CONSTRAINT article_id_in_abstract_fk FOREIGN KEY (article_id) REFERENCES Article(art_id)
);
```

```{sql connection=dbcon}
SELECT * FROM Abstract;
```

## ARTICLE AUTHOR JUNCTION

```{sql connection=dbcon}
DROP TABLE IF EXISTS Article_Author_Junction;
```

```{sql connection=dbcon}
CREATE TABLE Article_Author_Junction (
  art_aut_id INT PRIMARY KEY AUTO_INCREMENT,
  author_id INT NOT NULL,
  article_id INT NOT NULL,
  
  CONSTRAINT author_id_in_junction_fk FOREIGN KEY (author_id) REFERENCES Author(aut_id),
  CONSTRAINT article_id_fk FOREIGN KEY (article_id) REFERENCES Article(art_id)
);
```

```{sql connection=dbcon}
SELECT * FROM Article_Author_Junction;
```

## HISTORY

```{sql connection=dbcon}
DROP TABLE IF EXISTS History;
```

```{sql connection=dbcon}
CREATE TABLE History (
  hist_id INT PRIMARY KEY AUTO_INCREMENT,
  article_id INT NOT NULL,
  pub_status ENUM('received', 'accepted', 'epublish', 'entrez', 'pubmed', 'medline', 'revised', 'aheadofprint') NOT NULL,
  year INT NOT NULL,
  month INT NOT NULL,
  day INT NOT NULL,
  
  CONSTRAINT article_id_in_history_fk FOREIGN KEY (article_id) REFERENCES Article(art_id)
);
```

```{sql connection=dbcon}
SELECT * FROM History;
```

## JOURNAL

```{sql connection=dbcon}
DROP TABLE IF EXISTS Journal;
```

```{sql connection=dbcon}
CREATE TABLE Journal (
  j_id INT PRIMARY KEY AUTO_INCREMENT,
  journal_name VARCHAR(255) NOT NULL,
  issn VARCHAR(255) NOT NULL,
  issn_type ENUM('Electronic', 'Print') NOT NULL,
  iso_abbreviation VARCHAR(255) NOT NULL,
  journal_country VARCHAR(255) NOT NULL
  );
```

```{sql connection=dbcon}
SELECT * FROM Journal;
```

## JOURNAL_ISSUE

```{sql connection=dbcon}
DROP TABLE IF EXISTS Journal_Issue;
```

```{sql connection=dbcon}
CREATE TABLE Journal_Issue (
  issue_id INT PRIMARY KEY AUTO_INCREMENT,
  journal_id INT NOT NULL,
  volume INT NOT NULL,
  issue INT NOT NULL,
  publication_year INT NOT NULL,
  publication_month INT NOT NULL,
  
  CONSTRAINT journal_id_fk FOREIGN KEY (journal_id) REFERENCES Journal(j_id)
);
```

```{sql connection=dbcon}
SELECT * FROM Journal_Issue;
```


# Helper Functions

## Row Exists

A function to determine if a given row exists in a column. Returns the value of the first column of that row (primary key for that row) if all columns except the first one match, otherwise returns 0.

```{r}
rowExists <- function (aRow, aDF){
  # check if that address is already in the data frame
  num_rows <- nrow(aDF)
  num_cols <- ncol(aDF)
  
  if ( num_rows == 0 ){
    # data frame is empty, so can't exist
    return(0)
  }
  
  for ( i in 1:num_rows ){
    
    # check if all columns match for a row
    if ( all(aDF[i,2:ncol(aDF)] == aRow[1,]) ){
      
      # found a match; return it's ID
      return(aDF[i,1])
    }
  }
  
  # none matched
  return(0)
}
```


## monthYear

A function that converts a three character string, "MAR", to the correct month number. Returns NA if value passed in is NA. Throws an error if the entered VARCHAR(255) is not valid.

```{r}
monthYear <- function(month_text){
  standardized_month_text <- toupper(month_text)
  if ( is.na(standardized_month_text) ) return(NA)
  else if ( standardized_month_text == "JAN" ) return(1)
  else if ( standardized_month_text == "FEB" ) return (2)
  else if ( standardized_month_text == "MAR" ) return (3)
  else if ( standardized_month_text == "APR" ) return (4)
  else if ( standardized_month_text == "MAY" ) return (5)
  else if ( standardized_month_text == "JUN" ) return (6)
  else if ( standardized_month_text == "JUL" ) return (7)
  else if ( standardized_month_text == "AUG" ) return (8)
  else if ( standardized_month_text == "SEP" ) return (9)
  else if ( standardized_month_text == "OCT" ) return (10)
  else if ( standardized_month_text == "NOV" ) return (11)
  else if ( standardized_month_text == "DEC" ) return (12)
  stop("Month text not found. Could not convert to number.")
}
```


## parseJournalInfo

Takes an article_node and extracts needed information to add to article.df

```{r}
parseJournalInfo <- function(article_node){
  # Journal Title
  journalTitleQuery <- "./MedlineCitation/Article/Journal/Title"
  journalTitle <- xpathSApply(article_node, journalTitleQuery, xmlValue)

  # Journal Abbreviation
  journalAbbreviationQuery <- "./MedlineCitation/Article/Journal/ISOAbbreviation"
  journalAbbreviation <- xpathSApply(article_node, journalAbbreviationQuery, xmlValue)
  
  # ISSN ID
  journalISSNQuery <- "./MedlineCitation/Article/Journal/ISSN"
  journalISSN <- xpathSApply(article_node, journalISSNQuery, xmlValue)
  
  # ISSN Type
  journalIssnTypeQuery <- "./MedlineCitation/Article/Journal/ISSN/@IssnType"
  journalIssnType <- xpathSApply(article_node, journalIssnTypeQuery)

  # Journal Country
  journalCountryQuery <- "./MedlineCitation/MedlineJournalInfo/Country"
  journalCountry <- xpathSApply(article_node, journalCountryQuery, xmlValue)
  
  # Create temporary data frame to store new journal information
  a.journal <- data.frame(str_to_title(journalTitle), journalISSN,
                          journalIssnType, journalAbbreviation, 
                          journalCountry, stringsAsFactors = FALSE)
  
  return(a.journal)
}
```


## parseJournalIssueInfo

Takes an article_node and journal_id and extracts needed information to add to journal.df

```{r}
parseJournalIssueInfo <- function(journal_id, article_node){
  # Volume
  journalVolumeQuery <- "./MedlineCitation/Article/Journal/JournalIssue/Volume"
  journalVolume <- xpathSApply(article_node, journalVolumeQuery, xmlValue)
  
  # Issue
  journalIssueQuery <- "./MedlineCitation/Article/Journal/JournalIssue/Issue"
  journalIssue <- xpathSApply(article_node, journalIssueQuery, xmlValue)

  # Parse out publication data section of XML document
  publicationDataQuery <- "./MedlineCitation/Article/Journal/JournalIssue/PubDate"
  publicationData <- xpathSApply(article_node, publicationDataQuery)
  
  # Need to parse date differently: can be stored as MedlineDate or Month/Date
  if ( (xmlName(publicationData[[1]][[1]]) == 'MedlineDate') ) {
    
    ## if it is saved as MedlineDate, use substring to extract year and month
    journalIssueYearQuery <- "substring(./MedlineCitation/Article/Journal/JournalIssue/PubDate/MedlineDate,1, 4)"
    journalIssueYear <- xpathSApply(article_node, journalIssueYearQuery, xmlValue)
    
    journalIssueMonthQuery <- "substring(./MedlineCitation/Article/Journal/JournalIssue/PubDate/MedlineDate, 6, 3)"
    journalIssueMonth <- xpathSApply(article_node, journalIssueMonthQuery, xmlValue)
    
    # Use function to convert text month to numeric
    journalIssueMonth <- monthYear(journalIssueMonth)
  } 
  
  ## If it is not saved as Medline, parse out Year and Month
  else{
    
    # if month doesn't exist, set it equal to 1
    journalIssueYear <- 1
    journalIssueMonth <- 1
    
    # Because not every article has a pub month, using a for loop with xmlName to extract the data
    
    for ( j in 1:xmlSize(publicationData[[1]]) ){
      
      ## If year is found, save year so it isn't NA
      if ( xmlName(publicationData[[1]][[j]]) == 'Year' ){
        journalIssueYear <- xmlValue(publicationData[[1]][[j]])
      }
      
      ## If month is found, save so it isn't NA
      if ( xmlName(publicationData[[1]][[j]]) == 'Month' ){
        journalIssueMonth <- xmlValue(publicationData[[1]][[j]])
        
        # Use function to convert text month to numeric
        journalIssueMonth <- monthYear(journalIssueMonth)
      }
    }
  }
  
    an.issue <- data.frame(journal_id, journalVolume, journalIssue,
                         journalIssueYear, journalIssueMonth,
                         stringsAsFactors = FALSE)
  
  return(an.issue)
}
```

```{r}
parseArticleInfo <- function(issue_id, article_node){
  # Article Title
  articleTitleQuery <- "./MedlineCitation/Article/ArticleTitle"
  articleTitle <- xpathSApply(article_node, articleTitleQuery, xmlValue)
  
  # Pub Model
  pubModelQuery <- "./MedlineCitation/Article/@PubModel"
  pubModel <- xpathSApply(article_node, pubModelQuery)
  
  an.article <- data.frame(articleTitle, issue_id, pubModel)
  
  return(an.article)
}
```


## Create Data Frames

```{r}
author.df <- data.frame(aut_id = integer(),
                        author_last_name = character(),
                        author_fore_name = character(),
                        author_initials = character(),
                        stringsAsFactors = FALSE)

abstract.df <- data.frame(abstract_id = integer(),
                          article_id = integer(),
                          nlm_category = character(),
                          abstract_label = character(),
                          abstract_text = character(),
                          stringsAsFactors = FALSE)

article_author_junction.df <- data.frame(art_aut_id = integer(),
                                         author_id = integer(),
                                         article_id = integer(),
                                         stringsAsFactors = FALSE)

article.df <- data.frame(art_id = integer(),
                         article_title = character(),
                         journal_issue_id = integer(),
                         pub_model = character(),
                         stringsAsFactors = FALSE)

history.df <- data.frame(hist_id = integer(),
                         article_id = integer(),
                         pub_status = character(),
                         year = integer(),
                         month = integer(),
                         day = integer(),
                         stringsAsFactors = FALSE)

journal_issue.df <- data.frame(issue_id = integer(),
                               journal_id = integer(),
                               volume = integer(),
                               issue = integer(),
                               publication_year = integer(),
                               publication_month = integer(),
                               stringsAsFactors = FALSE)

journal.df <- data.frame(j_id = integer(),
                         journal_name = character(),
                         issn = character(),
                         issn_type = character(),
                         iso_abbreviation = character(),
                         journal_country = character(),
                         stringsAsFactors = FALSE)
```


# Load Data

## Parse XML Document

```{r}
fn <- "pubmed_sample.xml"

# Reading XML file and parse into DOM
xmlDOM <- xmlParse(file = fn, encoding="UTF-8") 

# gGt root node 
r <- xmlRoot(xmlDOM) 

# Get number of articles in XML file
numArticles <- xmlSize(r) 
```


## Parse Article Information

```{r}
# Looping through all of the articles
for ( i in 1:numArticles ){
  
  # parse first article
  article <- r[[i]]

  # ------------------- #
  # Journal Information #
  # ------------------- #
  
  a.journal <- parseJournalInfo(article)
  
  # Check to see if journal already exists in journal.df
  journalID <- rowExists(a.journal, journal.df)
  
  # If journal doesn't exist, add it to the data frame
  if ( journalID == 0 ){
    
    # Set journalID to be the next unused row num in journal.df
    journalID <- nrow(journal.df) + 1
    
    # add record to data frame
    journal.df[journalID,2:ncol(journal.df)] <- a.journal
    journal.df[journalID, 1] <- journalID
  }
  
  # ------------- #
  # Journal Issue #
  # ------------- #

  an.issue <- parseJournalIssueInfo(journalID, article)
  
  issueID <- rowExists(an.issue, journal_issue.df)
  
  # If journal issue doesn't exist, add it to the data frame
  if ( issueID == 0 ){
    
    # Set issue_id to be the next unused row num in journal_issue.df
    issueID <- nrow(journal_issue.df) + 1
    
    # add record to data frame
    journal_issue.df[issueID,2:ncol(journal_issue.df)] <- an.issue
    journal_issue.df[issueID, 1] <- issueID
  }
  
  # -------- #
  # Articles #
  # -------- #
  
  an.article <- parseArticleInfo(issueID, article)
  
  articleID <- rowExists(an.article, article.df)
  
  # If journal issue doesn't exist, add it to the data frame
  if ( articleID == 0 ){
    
    # Set issue_id to be the next unused row num in journal_issue.df
    articleID <- nrow(article.df) + 1
    
    # add record to data frame
    article.df[articleID,2:ncol(article.df)] <- an.article
    article.df[articleID, 1] <- articleID
  }
  
  # ------- #
  # Authors #
  # ------- #
  
  authorsQuery <- "./MedlineCitation/Article/AuthorList/Author"
  authorsResultSet <- xpathSApply(article, authorsQuery)

  # Loop through the AuthorsSet, extracting info and adding to authors table
  for ( j in 1:xmlSize(authorsResultSet) ){
    
    author <- authorsResultSet[[j]]
    last_name <- str_to_title(xmlValue(author[[1]]))
    fore_name <- str_to_title(xmlValue(author[[2]]))
    initials <- toupper(xmlValue(author[[3]]))

    an.author <- data.frame(last_name, fore_name, initials,
                          stringsAsFactors = FALSE)

    authorID <- rowExists(an.author, author.df)

    # If author doesn't exist, add it to the data frame
    if ( authorID == 0 ){

      # Set authorID to be the next unused row num in author.df
      authorID <- nrow(author.df) + 1

      # add record to data frame
      author.df[authorID,2:ncol(author.df)] <- an.author
      author.df[authorID, 1] <- authorID
    }
    
    # Retrieve next line in the junction table and add linking to author and article
    articleAuthorID <- nrow(article_author_junction.df) + 1
    an.article_author_junction <- data.frame(articleAuthorID, authorID, articleID)
    article_author_junction.df[articleAuthorID,] <- an.article_author_junction
  }
  
  # -------- #
  # Abstract #
  # -------- #

  abstractInfoQuery <- "./MedlineCitation/Article/Abstract/AbstractText"
  abstractInfoDataSet <- xpathSApply(article, abstractInfoQuery)

  # iterate through list of abstract info, create an abstract record and add it
  # to the abstract.df
  for ( j in 1:length(abstractInfoDataSet) ){
    abstractRecord <- abstractInfoDataSet[j]
    label <- xmlAttrs(abstractRecord[[1]])[1]
    nlm <- xmlAttrs(abstractRecord[[1]])[2]
    text <- xmlValue(abstractRecord[[1]])
    
    # if any of the data is not found, set it to UNKNOWN
    if ( is.null(label) ) label <- "UNKNOWN"
    if ( is.null(nlm) ) nlm <- "UNKNOWN"
    if ( is.null(text) ) text <- "UNKNOWN"

    abstractID <- nrow(abstract.df) + 1

    an.abstractEntry <- data.frame(abstractID, articleID, nlm, label, text )

    abstract.df[abstractID,] <- an.abstractEntry
  }

  # ------- #
  # History #
  # ------- #
  
  historyDataQuery <- "./PubmedData/History/PubMedPubDate"
  historyDataSet <- xpathSApply(article, historyDataQuery)
  
  for ( j in 1:length(historyDataSet) ){
    historyEntry <- historyDataSet[j]
    publicationStatus <- xmlAttrs(historyEntry[[1]])
    year <- xmlValue(historyEntry[[1]][[1]])
    month <- xmlValue(historyEntry[[1]][[2]])
    day <- xmlValue(historyEntry[[1]][[3]])
    
    historyEntryID <- nrow(history.df) + 1
    
    # add to df
    a.historyEntry <- data.frame(historyEntryID, articleID, publicationStatus, 
                                 year, month, day)
    history.df[historyEntryID,] <- a.historyEntry
  }
} 

```


# Upload Data

```{r}
author.df
```

## Prepare Data: Author

```{r}
dbWriteTable(dbcon, "Author", author.df, row.names = FALSE, append = TRUE)
```

## Prepare Data: Article

```{r}
dbWriteTable(dbcon, "Article", article.df, row.names = FALSE, append = TRUE)
```

## Prepare Data: Abstract

```{r}
dbWriteTable(dbcon, "Abstract", abstract.df, row.names = FALSE, append = TRUE)
```

## Prepare Data: Article Author Junction

```{r}
dbWriteTable(dbcon, "Article_Author_Junction", article_author_junction.df, row.names = FALSE, append = TRUE)
```

## Prepare Data: History

```{r}
dbWriteTable(dbcon, "History", history.df, row.names = FALSE, append = TRUE)
```

## Prepare Data: Journal

```{r}
dbWriteTable(dbcon, "Journal", journal.df, row.names = FALSE, append = TRUE)
```

## Prepare Data: Journal_Issue

```{r}
dbWriteTable(dbcon, "Journal_Issue", journal_issue.df, row.names = FALSE, append = TRUE)
```

```{sql connection=dbcon}
SET FOREIGN_KEY_CHECKS = 1;
```

## Queries to see if data is correct

```{sql connection=dbcon}
SELECT article_title
, journal_name
, volume
, issue
, publication_year
, publication_month
FROM Article AS A
JOIN Journal_Issue AS JI
ON A.art_id = JI.issue_id
JOIN Journal AS J
ON JI.journal_id = J.j_id;
;
```

```{sql connection=dbcon}
SELECT SUBSTRING(article_title, 1, 75) AS ArticleTitle
, COUNT(art_aut_id) As AuthorCount
FROM Article AS A
JOIN Article_Author_Junction AS AJ
ON A.art_id = AJ.article_id
JOIN Author AS AU
ON AJ.art_aut_id = AU.aut_id
GROUP BY article_title;
```

```{sql connection=dbcon}
SELECT A.article_title, JO.journal_name, J.publication_year, J.publication_month
FROM Article AS A
JOIN Journal_Issue AS J
ON A.journal_issue_id = J.issue_id
JOIN Journal AS JO
ON J.journal_id = JO.j_id
WHERE J.journal_id = 4 AND J.publication_year = 2012
ORDER BY J.publication_month ASC;
```

```{sql connection=dbcon}
SELECT AR.aut_id
, CONCAT(AR.author_last_name,", ", AR.author_fore_name) AS AuthorName,
       A.article_title, JO.journal_name, J.publication_year, J.publication_month
FROM Article_Author_Junction AS AJ
JOIN Author AS AR
ON AJ.author_id = AR.aut_id
JOIN Article AS A
ON A.art_id = AJ.article_id
JOIN Journal_Issue AS J
ON A.journal_issue_id = J.issue_id
JOIN Journal AS JO
ON J.journal_id = JO.j_id
WHERE AR.aut_id = 3 AND J.publication_year = 2012
ORDER BY J.publication_month ASC;
```

```{sql connection=dbcon}
SELECT DISTINCT(A.art_id)
FROM Article_Author_Junction AS AJ
JOIN Author AS AR
ON AJ.author_id = AR.aut_id
JOIN Article AS A
ON A.art_id = AJ.article_id
JOIN Journal_Issue AS J
ON A.journal_issue_id = J.issue_id
WHERE J.publication_year = 2012
AND J.journal_id = 4;
```

```{sql connection=dbcon}
SELECT CONCAT(AR.author_last_name,", ", AR.author_fore_name) AS AuthorName
, COUNT(AJ.author_id) AS ArticleCount
FROM Article_Author_Junction AS AJ
JOIN Author AS AR
ON AJ.author_id = AR.aut_id
JOIN Article AS A
ON A.art_id = AJ.article_id
JOIN Journal_Issue AS J
ON A.journal_issue_id = J.issue_id
JOIN Journal AS JO
ON J.journal_id = JO.j_id
WHERE J.publication_year = 2012 AND (J.publication_month >= 10 AND J.publication_month <= 12)
GROUP BY AR.aut_id
ORDER BY ArticleCount DESC;
```

```{sql connection=dbcon}
SELECT SUBSTRING(article_title, 1, 50) AS ArticleTitle
, journal_name
, volume
, issue
, publication_year
, publication_month
, H.pub_status
, H.year
, H.month, H.day
FROM Article AS A
JOIN Journal_Issue AS JI
ON A.art_id = JI.issue_id
JOIN Journal AS J
ON JI.journal_id = J.j_id
JOIN History AS H
ON H.article_id = A.art_id
WHERE A.art_id = 16;
```

```{sql connection=dbcon}
SELECT * FROM Author;
```

```{sql connection=dbcon}
SELECT article_title
, Abstract.*
FROM Article
JOIN Abstract
ON Article.art_id = Abstract.article_id
WHERE Article.art_id = 3;
```

```{sql connection=dbcon}
SELECT article_title
, Author.*
FROM Article
JOIN Article_Author_Junction
ON Article.art_id = Article_Author_Junction.article_id
JOIN Author
ON Article_Author_Junction.author_id = Author.aut_id
WHERE Article.art_id = 3;
```



# Create Star/Snowflake Schema

## Fact Table - Data Dump 

![](Practicum2 - Star Schema.png "Practicum2 - Star Schema") <https://lucid.app/lucidchart/5a835436-ec1a-461a-94d4-bd4d46ece96f/edit?viewport_loc=-1248%2C-504%2C6656%2C3144%2CgMo3rIrSBrSc&invitationId=inv_2685f3e2-beaf-4ddd-808d-a2ccd6c89094>

```{sql connection=dbcon}
DROP TABLE IF EXISTS Fact_Table_Dump;
```

```{sql connection=dbcon}
CREATE TABLE Fact_Table_Dump (
  article_id INT NOT NULL,
  article_title VARCHAR(255) NOT NULL,
  author_id INT NOT NULL,
  pub_model INT NOT NULL,
  journal_name VARCHAR(255) NOT NULL,
  issn INT NOT NULL,
  issn_type VARCHAR(255) NOT NULL,
  iso_abbreviation VARCHAR(255) NOT NULL,
  journal_country VARCHAR(255) NOT NULL,
  journal_id INT NOT NULL,
  volume INT NOT NULL,
  issue INT NOT NULL,
  ji_pub_year INT NOT NULL,
  ji_pub_month INT NOT NULL,
  pub_status VARCHAR(255) NOT NULL,
  pub_year INT NOT NULL,
  pub_month INT NOT NULL,
  pub_day INT NOT NULL
);
```

```{r}
# TODO: update the ERD for this
factTableDump.df <- dbGetQuery(dbcon, 'SELECT ART.art_id as article_id
                                , ART.article_title
                                , ART.pub_model
                                , AJ.author_id
                                , J.journal_name
                                , J.issn
                                , J.issn_type
                                , J.iso_abbreviation
                                , J.journal_country
                                , JI.journal_id
                                , JI.volume 
                                , JI.issue
                                , JI.publication_year as ji_pub_year
                                , JI.publication_month as ji_pub_month
                                , H.pub_status
                                , H.year as pub_year
                                , H.month as pub_month
                                , H.day as pub_day
                                FROM Journal AS J
                                JOIN Journal_Issue AS JI
                                ON JI.journal_id = J.j_id
                                JOIN Article AS ART
                                ON ART.journal_issue_id = JI.issue_id
                                JOIN Article_Author_Junction AS AJ
                                ON ART.art_id = AJ.article_id
                                JOIN History AS H
                                ON H.article_id = ART.art_id;')

```

```{r}
dbWriteTable(dbcon, "Fact_Table_Dump", factTableDump.df, row.names = FALSE, append = TRUE)
```





## Summarized Fact Table

### Functions to summarize the data

```{r}
# Function to return publication date of a journal as a date object
getPublicationDate <- function(article_id) {
  
  # Defining the sql statement
  sqlStatement <- paste0('SELECT CONCAT(JI.publication_year,"-"
                        , JI.publication_month,"-","01") 
                        AS PublicationDate
                        FROM Article
                        JOIN Journal_Issue AS JI
                        ON Article.journal_issue_id = JI.issue_id
                        WHERE art_id =', article_id)
  
  date <- dbGetQuery(dbcon, sqlStatement)
  
  # Looking for edge cases and defining them as NA
  if ( nrow(date) == 0 ) return(NA)
  
  return(as.Date(as.character(date), "%Y-%m-%d"))
}
```

```{r}
# Function to retrieve date of history event of an article
getHistoryDate <- function(article_id, history_event) {
  
  # Defining the sql statement
  sqlStatement <- paste0('SELECT CONCAT(History.year, "-"
                        , History.month, "-", History.day) 
                        AS DateReceived
                        FROM Article
                        JOIN History
                        ON Article.art_id = History.article_id
                        WHERE pub_status ="', history_event, '"
                        AND art_id = ', article_id)
  
  date <- dbGetQuery(dbcon, sqlStatement)
  
  # Looking for edge cases and defining them as NA
  if ( nrow(date) == 0 ) return(NA)

  return(as.Date(as.character(date), "%Y-%m-%d"))
}
```

```{r}
# Function to get the number of days to publish
daysToPub <- function(article_id) { 
  
  # Defining the variables
  received_date <- getHistoryDate(article_id, "received")
  pub_date <- getPublicationDate(article_id)
  
  # Looking for edge cases
  if ( is.na(received_date) ){
    difference <- 0
  
  # Otherwise calculating the difference between dates
  } else{
    difference <- difftime(pub_date, received_date, units = "days")
  }

  return(as.numeric(difference))
}
```

```{r}
# Function to find num of articles published by journal
numArticlesPublishedByJournalandAuthor <- function(journal_id, year, quarter, author_id) {
  
  if ( quarter == 0 ){
    sqlStatement <- paste0('SELECT COUNT(article_id)
                            FROM Fact_Table_Dump
                            WHERE journal_id =', journal_id, ' 
                            AND ji_pub_year = ', year,
                            ' AND author_id = ', author_id);
  
  } else if ( quarter == 1) {
    sqlStatement <- paste0('SELECT COUNT(article_id)
                            FROM Fact_Table_Dump
                            WHERE journal_id =', journal_id, 
                            ' AND ji_pub_year = ', year, 
                            ' AND (ji_pub_month >= 1 
                            AND ji_pub_month <= 3)',
                            ' AND author_id = ', author_id);
    
  } else if ( quarter == 2) {
    sqlStatement <- paste0('SELECT COUNT(article_id)
                            FROM Fact_Table_Dump
                            WHERE journal_id =', journal_id, 
                            ' AND ji_pub_year = ', year, 
                            ' AND (ji_pub_month >= 4 
                            AND ji_pub_month <= 6)',
                            ' AND author_id = ', author_id);
    
  } else if ( quarter == 3) {
    sqlStatement <- paste0('SELECT COUNT(article_id)
                            FROM Fact_Table_Dump
                            WHERE journal_id =', journal_id, 
                            ' AND ji_pub_year = ', year, 
                            ' AND (ji_pub_month >= 7
                            AND ji_pub_month <= 9)',
                            ' AND author_id = ', author_id);
    
  } else if ( quarter == 4) {
    sqlStatement <- paste0('SELECT COUNT(article_id)
                            FROM Fact_Table_Dump
                            WHERE journal_id =', journal_id, 
                            ' AND ji_pub_year = ', year, 
                            ' AND (ji_pub_month >= 10 
                            AND ji_pub_month <= 12)',
                            ' AND author_id = ', author_id);
  }
  
  count <- dbGetQuery(dbcon, sqlStatement)
  return(as.numeric(count))
}
```

```{r}
# Function to get num of articles with revisions based on journal
numArticlesRevisedByJournalandAuthor <- function(journal_id, year, quarter, author_id) {
  
  if ( quarter == 0 ){
    sqlStatement <- paste0('SELECT COUNT(article_id)
                            FROM Fact_Table_Dump
                            WHERE journal_id = ', journal_id, 
                            ' AND ji_pub_year = ', year,
                            ' AND pub_status = "revised"',
                            ' AND author_id = ', author_id);
    
  } else if ( quarter == 1) {
    sqlStatement <- paste0('SELECT COUNT(article_id)
                           FROM Fact_Table_Dump
                            WHERE journal_id = ', journal_id, 
                            ' AND ji_pub_year = ', year,
                            ' AND pub_status = "revised" 
                            AND (ji_pub_month >= 1 
                            AND ji_pub_month <= 3)',
                            ' AND author_id = ', author_id);
    
  } else if ( quarter == 2) {
    sqlStatement <- paste0('SELECT COUNT(article_id)
                            FROM Fact_Table_Dump
                            WHERE journal_id = ', journal_id, 
                            ' AND ji_pub_year = ', year,
                            ' AND pub_status = "revised" 
                            AND (ji_pub_month >= 4 
                            AND ji_pub_month <= 6)
                           AND author_id = ', author_id);
    
  } else if ( quarter == 3) {
    sqlStatement <- paste0('SELECT COUNT(article_id)
                            FROM Fact_Table_Dump
                            WHERE journal_id = ', journal_id, 
                            ' AND ji_pub_year = ', year,
                            ' AND pub_status = "revised" 
                            AND (ji_pub_month >= 7 
                            AND ji_pub_month <= 9)
                           AND author_id = ', author_id);
    
  } else if ( quarter == 4) {
    sqlStatement <- paste0('SELECT COUNT(article_id)
                            FROM Fact_Table_Dump
                            WHERE journal_id = ', journal_id, 
                            ' AND ji_pub_year = ', year,
                            ' AND pub_status = "revised" 
                            AND (ji_pub_month >= 10 
                            AND ji_pub_month <= 12)
                           AND author_id = ', author_id);
  }
  
  count <- dbGetQuery(dbcon, sqlStatement)
  return(as.numeric(count))
}
```

```{r}
# Function to find num of articles published by journal
numArticlesPublishedByJournal <- function(journal_id, year, quarter) {
  
  if ( quarter == 0 ){
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year);
  
  } else if ( quarter == 1) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id =', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 1 
                           AND JI.publication_month <= 3)');
  } else if ( quarter == 2) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id =', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 4 
                           AND JI.publication_month <= 6)');
    
  } else if ( quarter == 3) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id =', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 7
                           AND JI.publication_month <= 9)');
    
  } else if ( quarter == 4) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id =', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 10 
                           AND JI.publication_month <= 12)');
  }
  
  count <- dbGetQuery(dbcon, sqlStatement)[1]
  return(as.numeric(count))
}
```

```{r}
# Function to get num of articles with revisions based on journal
numArticlesRevisedByJournal <- function(journal_id, year, quarter) {
  
  if ( quarter == 0 ){
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised"');
    
  } else if ( quarter == 1) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised" 
                           AND (JI.publication_month >= 1 
                           AND JI.publication_month <= 3)');
    
  } else if ( quarter == 2) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised" 
                           AND (JI.publication_month >= 4 
                           AND JI.publication_month <= 6)');
    
  } else if ( quarter == 3) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised" 
                           AND (JI.publication_month >= 7 
                           AND JI.publication_month <= 9)');
    
  } else if ( quarter == 4) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised" 
                           AND (JI.publication_month >= 10 
                           AND JI.publication_month <= 12)');
  }
  
  count <- dbGetQuery(dbcon, sqlStatement)
  return(as.numeric(count))
}
```

```{r}
# Function to find num of articles published by journal
numArticlesPublishedByAuthor <- function(author_id, year, quarter) {
  
  if ( quarter == 0 ){
    sqlStatement <- paste0('SELECT COUNT(A.aut_id)
                            FROM Author AS A
                            JOIN Article_Author_Junction AS AJ
                            ON A.aut_id = AJ.author_id
                            JOIN Article AS ART
                            ON AJ.article_id = ART.art_id
                            JOIN Journal_Issue AS JI
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE A.aut_id = ', author_id, 
                           ' AND JI.publication_year = ', year);
  
  } else if ( quarter == 1) {
    sqlStatement <- paste0('SELECT COUNT(A.aut_id)
                            FROM Author AS A
                            JOIN Article_Author_Junction AS AJ
                            ON A.aut_id = AJ.author_id
                            JOIN Article AS ART
                            ON AJ.article_id = ART.art_id
                            JOIN Journal_Issue AS JI
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE A.aut_id = ', author_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 1 
                            AND JI.publication_month <= 3)');
  } else if ( quarter == 2) {
    sqlStatement <- paste0('SELECT COUNT(A.aut_id)
                            FROM Author AS A
                            JOIN Article_Author_Junction AS AJ
                            ON A.aut_id = AJ.author_id
                            JOIN Article AS ART
                            ON AJ.article_id = ART.art_id
                            JOIN Journal_Issue AS JI
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE A.aut_id = ', author_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 4 
                            AND JI.publication_month <= 6)');
    
  } else if ( quarter == 3) {
    sqlStatement <- paste0('SELECT COUNT(A.aut_id)
                            FROM Author AS A
                            JOIN Article_Author_Junction AS AJ
                            ON A.aut_id = AJ.author_id
                            JOIN Article AS ART
                            ON AJ.article_id = ART.art_id
                            JOIN Journal_Issue AS JI
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE A.aut_id = ', author_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 7
                            AND JI.publication_month <= 9)');
    
  } else if ( quarter == 4) {
    sqlStatement <- paste0('SELECT COUNT(A.aut_id)
                            FROM Author AS A
                            JOIN Article_Author_Junction AS AJ
                            ON A.aut_id = AJ.author_id
                            JOIN Article AS ART
                            ON AJ.article_id = ART.art_id
                            JOIN Journal_Issue AS JI
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE A.aut_id = ', author_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 10 
                             AND JI.publication_month <= 12)');
  }
  
  count <- dbGetQuery(dbcon, sqlStatement)[1]
  return(as.numeric(count))
}
```

# TODO: THIS
```{r}
# Function to get num of articles with revisions based on journal
numArticlesRevisedByAuthor <- function(journal_id, year, quarter) {
  
  if ( quarter == 0 ){
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised"');
    
  } else if ( quarter == 1) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised" 
                           AND (JI.publication_month >= 1 
                           AND JI.publication_month <= 3)');
    
  } else if ( quarter == 2) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised" 
                           AND (JI.publication_month >= 4 
                           AND JI.publication_month <= 6)');
    
  } else if ( quarter == 3) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised" 
                           AND (JI.publication_month >= 7 
                           AND JI.publication_month <= 9)');
    
  } else if ( quarter == 4) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            JOIN History AS H
                            ON ART.art_id = H.article_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year,
                            ' AND H.pub_status = "revised" 
                           AND (JI.publication_month >= 10 
                           AND JI.publication_month <= 12)');
  }
  
  count <- dbGetQuery(dbcon, sqlStatement)
  return(as.numeric(count))
}
```






```{r}
# Function to find the article IDs associated with each journal
articleIDsPublishedByJournal <- function(journal_id, year, quarter) {
  
  # if quarter information isn't provided, pull just based on year
  if ( quarter == 0 ){
    sqlStatement <- paste0('SELECT ART.art_id
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id = ', journal_id, 
                           ' AND JI.publication_year = ', year);
    
  } else if ( quarter == 1) {
    sqlStatement <- paste0('SELECT ART.art_id
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 1 
                           AND JI.publication_month <= 3)');
    
  } else if ( quarter == 2) {
    sqlStatement <- paste0('SELECT ART.art_id
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 4 
                           AND JI.publication_month <= 6)');
    
  } else if ( quarter == 3) {
    sqlStatement <- paste0('SELECT ART.art_id
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 7 
                           AND JI.publication_month <= 9)');
    
  } else if ( quarter == 4) {
    sqlStatement <- paste0('SELECT ART.art_id
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id = ', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 10 
                           AND JI.publication_month <= 12)');
  }
  
  article_list <- dbGetQuery(dbcon, sqlStatement)[[1]]
  if ( length(article_list) == 0 ) return(NA)
  return(article_list)
}
```

```{sql connection=dbcon}
SELECT COUNT(ART.art_id)
FROM Journal AS J
JOIN Journal_Issue AS JI
ON JI.journal_id = J.j_id
JOIN Article AS ART
ON ART.journal_issue_id = JI.issue_id
WHERE J.j_id = 1 
AND JI.publication_year = 2012;
```


```{r}
avgDaysToPub <- function(article_list) {
  
  if ( is.na(article_list[1]) ) return(0)
  
  total <- 0
  size <- length(article_list)
  
  if ( size == 1 ) { 
    return (daysToPub(article_list[1]))
  } else {
    
    # else iterating over the list
    for ( i in size ) {
      day_result <- daysToPub(article_list[i])
      total <- total + day_result
    }
  
    return(total / size)
  }
}
```

```{r}
# just for testing 
# TODO: delete later
numArticlesPublishedByJournal(1,2012,0)
article_list <- articleIDsPublishedByJournal(1, 2012, 0)

article_list
length(article_list)

avgDaysToPub(article_list)


```

### Set up dimensions for summary table

```{r}
# Create the data frames
dim_year.df <- data.frame(dim_year_key = integer(),
                          dim_year_description = character(),
                          stringsAsFactors = FALSE)

# Extract all possible years from the publication information
publication_years <- dbGetQuery(dbcon, "SELECT DISTINCT publication_year 
                                        AS year 
                                        FROM Journal_Issue")
publication_years <- publication_years[,1]

# Define the ALL
dim_year.df[1,] <- data.frame(0, "ALL")

# Load the data frame
for ( i in 1:length(publication_years) ) {
  row_number <- nrow(dim_year.df) + 1
  dim_year.df[row_number,] <- data.frame(i, publication_years[i]) 
}

```

```{r}
# Create the data frame
dim_quarter.df <- data.frame(dim_quarter_key = integer(),
                             dim_quarter_description = character(),
                             stringsAsFactors = FALSE)

# Define all possible quarters
quarters_list = c("ALL", "Q1", "Q2", "Q3", "Q4")

# Load the data frame
for ( i in 1:length(quarters_list) ){
  dim_quarter.df[i,] <- data.frame(i-1, quarters_list[i])
}
```

```{r}
# Create the data frame
dim_author.df <- data.frame(dim_author_key = integer(),
                            dim_author_last_name = character(),
                            dim_author_fore_name = character(),
                            dim_author_initials = character(),
                            stringsAsFactors = FALSE)

# Define the ALL
dim_author.df[1,] <- data.frame(0, "ALL", "ALL", "ALL")

# Load the data frame
author_info_from_db <- dbGetQuery(dbcon, "SELECT Author.aut_id AS dim_author_key, 
                                          Author.author_last_name AS dim_author_last_name, 
                                          Author.author_fore_name AS dim_author_fore_name, 
                                          Author.author_initials AS dim_author_initials
                                          FROM Author")

dim_author.df <- rbind(dim_author.df, author_info_from_db)


```

```{r}
# Create the data frame
dim_journal.df <- data.frame(dim_journal_key = integer(),
                             dim_journal_name = integer(),
                             dim_journal_country = integer(),
                             stringsAsFactors = FALSE)

# Define the ALL
dim_journal.df[1,] <- data.frame(0, "ALL", "ALL")

# Load the data frame
journal_info_from_db <- dbGetQuery(dbcon, "SELECT j_id AS dim_journal_key, 
                                           journal_name AS dim_journal_name,
                                           journal_country AS dim_journal_country
                                           FROM Journal;")

dim_journal.df <- rbind(dim_journal.df, journal_info_from_db)
```

### Summary table 

```{r}
# Create the summary data frame
fact_table.df <- data.frame(fact_id = integer(),
                           journal_id = integer(),
                           author_id = integer(),
                           dim_year = integer(),
                           dim_qurter = integer(),
                           num_articles_published = integer(),
                           avg_days_to_submission = integer(),
                           num_articles_with_revisions = integer(),
                           stringsAsFactors = FALSE)

fact_table.df
```

## Populate the data for the summary table

```{r}
# loop through each journal, except the first "ALL"
for ( i in 2:nrow(dim_journal.df) ) {
  
  # loop through each quarter, incl the "ALL" quarter to get yearly totals
  for ( j in 1:nrow(dim_quarter.df) ) {
    
    # loop through each year, except the first "ALL"
    for ( k in 2:nrow(dim_year.df) ) {
    
      # add in primary key
      pk <- nrow(fact_table.df) + 1
      
      # set up ids in fact table
      journal_id <- dim_journal.df[i,]$dim_journal_key  
      quarter <- dim_quarter.df[j,]$dim_quarter_key
      year <- dim_year.df[k,]$dim_year_key
      author_id <- 0
      year_description <- dim_year.df[k,]$dim_year_description
      
      # get number of articles published
      num_published <- numArticlesPublishedByJournal(
        journal_id, year_description, quarter)
      
      # retrieve the list of articles for analysis
      article_list <- articleIDsPublishedByJournal(
        journal_id, year_description, quarter)
      
      # get average days to publish
        days_to_pub <- avgDaysToPub(article_list)
      
      # get num revisions
      num_revisions <- numArticlesRevisedByJournal(
        journal_id, year_description, quarter)
      
      # put the data into the data frame
      fact_table.df[pk,] <- data.frame(
        pk, journal_id, author_id, year, quarter, 
        num_published, days_to_pub, num_revisions, 
        stringsAsFactors = FALSE)
    }
  }
}
fact_table.df
```

```{r}
# loop through each author, except the first "ALL"
for ( i in 2:nrow(dim_author.df) ) {
  
  # loop through each quarter, incl the "ALL" quarter to get yearly totals
  for ( j in 1:nrow(dim_quarter.df) ) {
    
    # loop through each year, except the first "ALL"
    for ( k in 2:nrow(dim_year.df) ) {
      
      # add in primary key
      pk <- nrow(fact_table.df) + 1
      
      # set up ids in fact table
      journal_id <- 0 
      quarter <- dim_quarter.df[j,]$dim_quarter_key
      year <- dim_year.df[k,]$dim_year_key
      author_id <- dim_author.df[i,]$dim_author_key
      year_description <- dim_year.df[k,]$dim_year_description
      
      # get number of articles published
      num_published <- numArticlesPublishedByAuthor(
        author_id, year_description, quarter)
      
      # # retrieve the list of articles for analysis
      # article_list <- articleIDsPublishedByJournal(
      #   journal_id, year_description, quarter)
      # 
      # # get average days to publish
      #   days_to_pub <- avgDaysToPub(article_list)
        days_to_pub <- 1234
      
      # get num revisions
      # num_revisions <- numArticlesRevisedByJournal(
      #   journal_id, year_description, quarter)
        num_revisions <- 2345
      
      # put the data into the data frame
      fact_table.df[pk,] <- data.frame(
        pk, journal_id, author_id, year, quarter, 
        num_published, days_to_pub, num_revisions, 
        stringsAsFactors = FALSE)      
      
    }
  }
}
```



```{r}
# we can run this when you think the table is OK
dbWriteTable(dbcon, "Summary_Fact_Table", fact_table.df, row.names = FALSE, append = TRUE)
```

# Explore and Mine Data

## Global variables

```{r}
# getting the size of the article count
size <- dbGetQuery(dbcon, 'SELECT COUNT(art_id) AS art_count 
                          FROM Article')
size <- size$art_count
```

## Trends in seasonality

```{r}
seasonal_info <- dbGetQuery(dbcon, 'SELECT COUNT(ART.art_id) as article_count
                                    , CASE 
                                      WHEN (JI.publication_month >= 0 
                                      AND JI.publication_month <= 3)
                                        THEN CONCAT(JI.publication_year, "-", 1)
                                      WHEN (JI.publication_month >= 4 
                                      AND JI.publication_month <= 6) 
                                        THEN CONCAT(JI.publication_year, "-", 2)
                                      WHEN (JI.publication_month >= 7 
                                      AND JI.publication_month <= 9) 
                                        THEN CONCAT(JI.publication_year, "-", 3)
                                      WHEN (JI.publication_month >= 10 
                                      AND JI.publication_month <= 12) 
                                        THEN CONCAT(JI.publication_year, "-", 4)
                                    END AS year_quarter
                                    FROM Article AS ART
                                    JOIN Journal_Issue AS JI
                                    ON ART.journal_issue_id = JI.issue_id
                                    GROUP BY JI.publication_year, year_quarter
                                    ORDER BY JI.publication_year, year_quarter')

seasonal_info
  
```

```{r}
#TODO: use the summary table to make this visualization

# setting up the variables
x_axis <- seasonal_info$year_quarter
y_axis <- seasonal_info$article_count

# adorning the bar chart
barChart <- ggplot(
  data = seasonal_info, aes(x = x_axis, y = y_axis)) + 
  geom_bar(stat = "identity", aes(fill = year_quarter)) + 
  labs(x = "Quarter", y = "Num of Articles") + 
  guides(fill = FALSE) 

print(barChart)
```
## Trends in duration until publication

```{r}
# Function to return publication date of a journal as a date object
getPublicationDate <- function(article_id) {
  
  # defining the sql statement
  sqlStatement <- paste0('SELECT CONCAT(JI.publication_year,"-"
                          ,JI.publication_month,"-","01") AS PublicationDate
                          FROM Article
                          JOIN Journal_Issue AS JI
                          ON Article.journal_issue_id = JI.issue_id
                          WHERE art_id =', article_id)
  date <- dbGetQuery(dbcon, sqlStatement)
  
  # looking for edge cases and defining them as NA
  if ( nrow(date) == 0 ) return(NA)
  
  return(as.Date(as.character(date), "%Y-%m-%d"))
}
```

```{r}
# Function to retrieve date of history event of an article
getHistoryDate <- function(article_id, history_event) {
  
  # defining the sql statement
  sqlStatement <- paste0('SELECT CONCAT(History.year, "-", History.month
                          , "-", History.day) AS DateReceived
                          FROM Article
                          JOIN History
                          ON Article.art_id = History.article_id
                          WHERE pub_status ="', history_event, '" AND art_id = ', article_id)
  date <- dbGetQuery(dbcon, sqlStatement)
  
  # looking for edge cases and defining them as NA
  if ( nrow(date) == 0 ) return(NA)
  
  return(as.Date(as.character(date), "%Y-%m-%d"))
}
```

```{r}
# testing the functions together to get the date difference in weeks
received_date <- getHistoryDate(1, "received")
pub_date <- getPublicationDate(1)
difference <- difftime(pub_date, received_date, units = "weeks")
```

```{r}
# defining the new data frame
pub_information <- data.frame(art_id = character(),
                              pub_date = as.Date(character()),
                              received_date = as.Date(character()),
                              date_diff = integer(),
                              weeks_dff = integer(),
                              stringsAsFactors = FALSE)

# iterating over the entire list
for ( i in 1:size ){
  pub_date <- getPublicationDate(i)
  received_date <- getHistoryDate(i, "received")

  # looking at edge cases and defining a standard 0
  if ( is.na(received_date) ) {
    days_difference <- 0
    weeks_difference <- 0
  
  # running the calc on normal cases  
  } else {
    days_difference <- difftime(pub_date, received_date, units = "days")
    weeks_difference <- difftime(pub_date, received_date, units = "weeks")
  }
  
  # putting the data into the data frame
  pub_information[i,] <- data.frame(i, pub_date, received_date, 
                                    days_difference, weeks_difference)
}

pub_information
```

```{r}
# setting up the variables
x_axis <- as.numeric(pub_information$art_id)
y_axis <- as.numeric(pub_information$weeks_dff)
y_avg <- round(mean(y_axis),0)
avg_string <- paste("Avg:", y_avg, sep=" ")

# adorning the bar chart
barChart <- ggplot(
  data = pub_information, aes(x = x_axis, y = y_axis)) + 
  geom_bar(stat = "identity", aes(fill = art_id)) + 
  labs(x = "Article ID", y = "Weeks to publish") + 
  geom_hline(yintercept = y_avg, color = "black") + 
  geom_text(aes(0, y_avg,label = avg_string, vjust = -1, hjust = -8)) +
  guides(fill = FALSE) 

print(barChart)
```

```{r}
dbDisconnect(dbcon)
```
