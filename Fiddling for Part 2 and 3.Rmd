---
title: "R Notebook"
output: html_notebook
---

```{r}
library(DBI)
library(RMySQL)
library(XML)
library(sqldf)
library(dplyr)    ## For removing duplicate values in dataframe
library(stringr)  ## For capitalization
```

```{r}
db_user <- "dbadmin"
db_name <- 'SandboxDB'
db_password <- "dos8JINT.kras8jaun"
db_host <- "cs5200-dbs.ctuc7sl6qeau.us-east-2.rds.amazonaws.com"
db_port <- 3306

dbcon <- dbConnect(MySQL(), dbname = db_name, host = db_host, 
                   port = db_port, user = db_user, password = db_password)
```

## Building query to  extract publication date
```{sql connection=dbcon}
SELECT CONCAT(JI.publication_year,"-",JI.publication_month,"-","01") AS PublicationDate
FROM Article
JOIN Journal_Issue AS JI
ON Article.journal_issue_id = JI.issue_id
WHERE art_id = 1;
```

## Building query to extract date received
### Can replace "recieved" with any other pub status
```{sql connection=dbcon}
SELECT CONCAT(History.year, "-", History.month, "-", History.day) AS DateReceived
FROM Article
JOIN History
ON Article.art_id = History.article_id
WHERE pub_status = "received" AND art_id = 1;
```

## Function to return publication date of a journal as a date object
```{r}
getPublicationDate <- function(article_id){
  sqlStatement <- paste0('SELECT CONCAT(JI.publication_year,"-",JI.publication_month,"-","01") AS PublicationDate
                          FROM Article
                          JOIN Journal_Issue AS JI
                          ON Article.journal_issue_id = JI.issue_id
                          WHERE art_id =', article_id)
  date <- dbGetQuery(dbcon, sqlStatement)
  
  if ( nrow(date) == 0 ) return(NA)
  
  format = "%Y-%m-%d"
  return(as.Date(as.character(date), format))
}
```

## Function to retrieve date of history event of an article
### Inputs: an article_id (an int) and a history event (a string)
```{r}
getHistoryDate <- function(article_id, history_event){
  sqlStatement <- paste0('SELECT CONCAT(History.year, "-", History.month, "-", History.day) AS DateReceived
                          FROM Article
                          JOIN History
                          ON Article.art_id = History.article_id
                          WHERE pub_status ="', history_event, '" AND art_id = ', article_id)
  date <- dbGetQuery(dbcon, sqlStatement)
  
  if ( nrow(date) == 0 ) return(NA)


  format = "%Y-%m-%d"
  return(as.Date(as.character(date), format))}
```

# Just fiddling with the difftime function
```{r}
received_date <- getHistoryDate(1, "received")
pub_date <- getPublicationDate(1)
difference <- difftime(pub_date, received_date, units = "weeks")
received_date
pub_date
difference
```

# Fiddling with creating a df that shows difference between when an article was received and then published
```{r}
pub_information <- data.frame(art_id = character(),
                              pub_date = as.Date(character()),
                              received_date = as.Date(character()),
                              date_diff = integer(),
                              weeks_dff = integer(),
                              stringsAsFactors = FALSE)

for ( i in 1:19 ){
  pub_date <- getPublicationDate(i)
  received_date <- getHistoryDate(i, "received")

  if ( is.na(received_date) ) {
    days_difference <- 0
    weeks_difference <- 0
  } else {
    days_difference <- difftime(pub_date, received_date, units = "days")
    weeks_difference <- difftime(pub_date, received_date, units = "weeks")

  }
  
  new_entry <- data.frame(i, pub_date, received_date, days_difference, weeks_difference)
  
  pub_information[i,] <- new_entry
}

pub_information
```

# Draft of a summary table

```{r}
# Create the data frames
dim_year.df <- data.frame(dim_year_key = integer(),
                          dim_year_description = character(),
                          stringsAsFactors = FALSE)

# extract all possible years from the publication information and history tables
publication_years <- dbGetQuery(dbcon, "SELECT DISTINCT publication_year AS year FROM Journal_Issue")
history_years <- dbGetQuery(dbcon,"SELECT DISTINCT year AS year FROM History")

# combine and make them a sorted vector for insertion into the data frame
total_years <- unique(rbind(publication_years, history_years))
year_list <- sort(as.character(total_years[,1]))

# load the data frame
dim_year.df[1,] <- data.frame(0, "ALL")
for ( i in 1:length(year_list) ){
  row_number <- nrow(dim_year.df) + 1
  dim_year.df[row_number,] <- data.frame(i, year_list[i])
}


dim_quarter.df <- data.frame(dim_quarter_key = integer(),
                             dim_quarter_description = character(),
                             stringsAsFactors = FALSE)

quarters_list = c("ALL", "Q1", "Q2", "Q3", "Q4")
for ( i in 1:length(quarters) ){
  dim_quarter.df[i,] <- data.frame(i-1, quarters_list[i])
}


dim_author.df <- data.frame(dim_author_key = integer(),
                            dim_author_last_name = character(),
                            dim_author_fore_name = character(),
                            dim_author_initials = character(),
                            stringsAsFactors = FALSE)

dim_author.df[1,] <- data.frame(0, "ALL", "ALL", "ALL")

author_info_from_db <- dbGetQuery(dbcon, "SELECT Author.aut_id AS dim_author_key, 
                                          Author.author_last_name AS dim_author_last_name, 
                                          Author.author_fore_name AS dim_author_fore_name, 
                                          Author.author_initials AS dim_author_initials
                                          FROM Author")
dim_author.df <- rbind(dim_author.df, author_info_from_db)



dim_journal.df <- data.frame(dim_journal_key = integer(),
                             dim_journal_name = integer(),
                             dim_journal_country = integer(),
                             stringsAsFactors = FALSE)

dim_journal.df[1,] <- data.frame(0, "ALL", "ALL")

journal_info_from_db <- dbGetQuery(dbcon, "SELECT j_id AS dim_journal_key, 
                                           journal_name AS dim_journal_name,
                                           journal_country AS dim_journal_country
                                           FROM Journal;")

dim_journal.df <- rbind(dim_journal.df, journal_info_from_db)


fact_table.df <- data.frame(fact_id = integer(),
                           journal_id = integer(),
                           author_id = integer(),
                           dim_year = integer(),
                           dim_qurter = integer(),
                           num_articles_published = integer(),
                           avg_days_to_submission = integer(),
                           num_articles_with_revisions = integer(),
                          stringsAsFactors = FALSE)
```

```{r}
dim_author.df
dim_journal.df
dim_quarter.df
```

# populating the fact table
```{r}
# journal info for the entire year
# journal info for each quarter

# author info for the entire year
# author info for each quarter
```

```{r}
numArticlesPublishedByJournal <- function(journal_id, year, quarter){
  # if quarter information isn't provided, pull just based on year
  if ( quarter == 0 ){
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id =', journal_id, ' AND JI.publication_year = ', year);
  } else if ( quarter == 1) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id =', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 1 AND JI.publication_month <= 3)');
  } else if ( quarter == 2) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id =', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 4 AND JI.publication_month <= 6)');
  } else if ( quarter == 3) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id =', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 7 AND JI.publication_month <= 9)');
  } else if ( quarter == 4) {
    sqlStatement <- paste0('SELECT COUNT(ART.art_id)
                            FROM Journal AS J
                            JOIN Journal_Issue AS JI
                            ON JI.journal_id = J.j_id
                            JOIN Article AS ART
                            ON ART.journal_issue_id = JI.issue_id
                            WHERE J.j_id =', journal_id, 
                            ' AND JI.publication_year = ', year, 
                            ' AND (JI.publication_month >= 10 AND JI.publication_month <= 12)');
  }
  
  count <- dbGetQuery(dbcon, sqlStatement)
  return(as.numeric(count))
}
```

```{r}
numArticlesPublishedByJournal(3,2012, 4)
```

# Get the number of articles given a journal number and year
```{sql connection=dbcon}
SELECT COUNT(ART.art_id)
FROM Journal AS J
JOIN Journal_Issue AS JI
ON JI.journal_id = J.j_id
JOIN Article AS ART
ON ART.journal_issue_id = JI.issue_id
WHERE J.j_id = 3 AND JI.publication_year=2013;
```

# get the number of articles in a given journal by year and quarter
```{sql connection=dbcon}
SELECT COUNT(ART.art_id)
FROM Journal AS J
JOIN Journal_Issue AS JI
ON JI.journal_id = J.j_id
JOIN Article AS ART
ON ART.journal_issue_id = JI.issue_id
WHERE J.j_id = 3 AND JI.publication_year=2013 AND (JI.publication_month <= 1 AND JI.publication_month >= 3);
```

# get the number of article revisions for a journal in a year
```{sql connection=dbcon}
SELECT COUNT(ART.art_id)
FROM Journal AS J
JOIN Journal_Issue AS JI
ON JI.journal_id = J.j_id
JOIN Article AS ART
ON ART.journal_issue_id = JI.issue_id
JOIN History AS H
ON ART.art_id = H.article_id
WHERE J.j_id = 1 AND JI.publication_year=2013 AND H.pub_status="revised";
```

# get the average time from submission to publication
```{r}
# retrieve list of article ids
# 
```

